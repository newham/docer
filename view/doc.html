<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>{{.filename}}</title>
    <link rel="icon" href="/public/docer_logo.ico" type="image/x-icon"/>

    <!-- <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.css" rel="stylesheet"> -->
    <!-- <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap-grid.min.css" rel="stylesheet"> -->
    <link href="https://cdn.bootcss.com/twitter-bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="/public/docer.css" rel="stylesheet"/>

    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/twitter-bootstrap/3.4.1/js/bootstrap.min.js"></script>


</head>

<body>


<div id="docer">
    <!--modal start-->
    <!-- 1 -->
    <div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="saveModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 class="modal-title" id="saveModalLabel">另存为</h3>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" v-model="article.file">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" v-on:click="postArticle()" data-dismiss="modal">保存
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    <!-- 2 -->
    <div class="modal fade" id="folderModal" tabindex="-1" role="dialog" aria-labelledby="folderModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 class="modal-title" id="folderModalLabel">打开</h3>
                </div>
                <div class="modal-body">
                    <ul>
                        <li v-for="file in folder.files">
                            <a v-on:click="openArticles(file.name)" data-dismiss="modal">${file.name}</a>
                        </li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    <!-- 3 -->
    <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 class="modal-title" id="confirmModalLabel">新建文件</h3>
                </div>
                <div class="modal-body">
                    是否保存${article.file}?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal"
                            v-on:click="$('#filenameModal').modal('show');">不保存
                    </button>
                    <button type="button" class="btn btn-primary" v-on:click="postArticle()" data-dismiss="modal">保存
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    <!-- 4 -->
    <div class="modal fade" id="filenameModal" tabindex="-1" role="dialog" aria-labelledby="filenameModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 class="modal-title" id="filenameModalLabel">新建</h3>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" v-model="newFilename">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal"
                            v-on:click="newArticle(newFilename)">确定
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    <!--modal end-->
    <div class="tool-bar navbar-fixed-top">
        <div class="title text-center">
            <div class="logo">
                <a class="pull-left" href="/">DOCER</a>
            </div>
            <span>${article.file}</span>
            <span>${isEdited}</span>
        </div>
        <div class="row" style="background: #efefef;padding: 5px 15px;">
            <div class="col-md-9 col-xs-6">
                <a type="button" class="btn btn-default btn-sm" href="/">
                    <span class="glyphicon glyphicon-home"></span>
                </a>
                <button type="button" class="btn btn-default btn-sm" v-on:click="confirmArticle();">
                    <span class="glyphicon glyphicon-file"></span>
                </button>
                <button type="button" class="btn btn-default btn-sm" v-on:click="showArticles()">
                    <span class="glyphicon glyphicon-folder-open"></span>
                </button>
                <button type="button" class="btn btn-default btn-sm" v-on:click="postArticle()">
                    <span class="glyphicon glyphicon-floppy-disk"></span>
                </button>
                <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#saveModal">
                    <span class="glyphicon glyphicon-floppy-open"></span>
                </button>
                <button type="button" class="btn btn-default btn-sm">
                    <span class="glyphicon glyphicon-eye-open"></span>
                </button>
                <!-- <button type="button" class="btn btn-default btn-sm">
                    打开
                </button> -->

                {{/*                <button type="button" class="btn btn-default btn-sm">*/}}
                {{/*                    <span class="glyphicon glyphicon-arrow-left"></span>*/}}
                {{/*                </button>*/}}
                {{/*                <button type="button" class="btn btn-default btn-sm">*/}}
                {{/*                    <span class="glyphicon glyphicon-arrow-right"></span>*/}}
                {{/*                </button>*/}}

            </div>

            <div class="col-md-3 col-xs-6">
                <div class="input-group input-group-sm ">
                    <input type="text" class="form-control">
                    <span class="input-group-btn ">
                            <button class="btn btn-success" type="button">搜索</button>
                        </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid content">
        <div class="row border-bottom">
            <div class="col-md-12">
                <h3>标题</h3>
                <input v-model="article.title" type="text" id="title" @keyup.down="downTitle()"
                       class="form-control p-3">
            </div>
            <!--<div class="col-md-12">
            <div class="input-group input-group-sm p-3">
                <span class="input-group-addon">输入：</span>
                <input v-model="content" type="text" id="title" @keyup.down="downTitle()" class="form-control">
            </div>

        </div>-->

        </div>
        <div class="row border-bottom">
            <div class="col-xs-8 col-md-3">
                <h3>章节</h3>
            </div>
            <div class="col-xs-8 col-md-6">
                <h3>正文</h3>
            </div>
            <div class="col-xs-4 col-md-3">
                <h3>引用</h3>
            </div>
        </div>
        <div class="row ">
            <div class="col-xs-8 col-md-9">
                <div class="row chapter" v-for="(chapter,i) in article.chapters">
                    <div class="col-xs-12 col-md-4">
                        <div class="input-group input-group-sm p-2">
                                <span class="input-group-addon">
                                    <select v-model="chapter.level">
                                        <option value=1>1</option>
                                        <option value=2>2</option>
                                        <option value=3>3</option>
                                        <option value=4>4</option>
                                        <option value=5>5</option>
                                    </select>
                                    级
                                </span>

                            <input v-model="chapter.title" type="text" v-bind:id="'c-'+i"
                                   @keyup.enter="addChapter(i)" @keyup.up="upChapter(i)" @keyup.down="downChapter(i)"
                                   @keyup.right="rightChapter(i)" class="form-control">
                            <span class="input-group-btn">
                                    <button v-on:click="addChapter(i)" class="btn btn-default">+</button>
                                    <button v-on:click="delChapter(i)" class="btn btn-default">x</button>
                                </span>
                        </div>
                    </div>
                    <div class="col-xs-12 col-md-8">
                        <div v-for="(line,j) in chapter.lines" class="input-group input-group-sm p-2">
                            {{/*                    <span class="input-group-addon">${j+1}</span>*/}}
                            <input v-model="line.content" type="text" @keyup.enter="addContent(i,j)"
                                   class="form-control" @keyup.up="upContent(i,j)" @keyup.down="downContent(i,j)"
                                   @keyup.46="delContent(i,j)" @keyup.right="focusReference(0)"
                                   @keyup.left="focusChapter(i)" v-bind:id="'c-'+i+'-c-'+j">
                            <!-- @keyup.46="delContent(i,j)" -->
                            <span class="input-group-btn">
                                    <span class="btn btn-default">
                                        <select v-model="line.reference">
                                            <option v-bind:value="-1">无</option>
                                            <option v-bind:value="reference.id"
                                                    v-for="(reference,n) in article.references" data-toggle="tooltip"
                                                    v-bind:title="reference.text">[${n+1}]</option>
                                        </select>
                                    </span>
                                    <button v-on:click="addContent(i,j)" class="btn btn-default">+</button>
                                    <button v-on:click="delContent(i,j)" class="btn btn-default">x</button>
                                </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-4 col-md-3">
                <div class="row references">
                    <div class="col-lg-12">
                        <div class="input-group input-group-sm p-2" v-for="(r,k) in article.references">
                            <span class="input-group-addon">[${k+1}]</span>
                            <input v-model="r.text" v-bind:id="'r-'+k" type="text" class="form-control"
                                   @keyup.enter="addReference(k)" @keyup.down="focusReference(k+1)"
                                   @keyup.up="focusReference(k-1)" @keyup.left="focusContent(0,0)">
                            <span class="input-group-btn">
                                    <button v-on:click="addReference(k)" class="btn btn-default">+</button>
                                    <button v-on:click="delReference(k)" class="btn btn-default">x</button>
                                </span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <footer class="navbar-fixed-bottom text-right">

        行数:<span>${article.lines}</span> 字数:<span>${article.words}</span>

    </footer>
</div>
</body>

<script>
    var current_chapter_index = 0, current_chapter_line_index = 0, current_reference_index = 0;
    var add_type = -1;
    // var show_type = 1;
    var vm = new Vue({
        delimiters: ['${', '}'],
        el: '#docer',
        data: {
            newFilename: "新建文档.json",
            isEdited: "",
            content: "",
            article: {},
            folder: {}
        },
        methods: {
            newArticle: function (name) {
                if (name == "") {
                    alert("file name is null");
                    return
                }
                this.article = {
                    file: name,
                    title: "",
                    words: 0,
                    lines: 0,
                    chapters: [
                        {
                            level: 1,
                            title: "",
                            lines: [
                                {
                                    content: "",
                                    translation: "",
                                    reference: -1
                                },
                            ]
                        }
                    ],
                    references: [
                        {
                            id: (new Date()).valueOf(),
                            text: ""
                        }
                    ]
                }
            },
            focusTitle: function (i) {
                document.getElementById("title").focus();
            },
            downTitle: function (i) {
                this.focusChapter(0);
            },
            addChapter: function (i) {
                // if(this.article.chapters[i].title==""){ //本行为空，禁止增加新行
                //     return
                // }
                i++;
                console.log("add", i);
                this.article.chapters.splice(i, 0, {
                    title: "",
                    level: 1,
                    lines: [
                        {content: "", translation: "", reference: -1},
                    ]
                });
                current_chapter_index = i;
                add_type = 1;
            },
            delChapter: function (i) {
                if (this.article.chapters.length == 1) {
                    return;
                }
                this.article.chapters.splice(i, 1);
                console.log("del", i);
                //foucs up item
                current_chapter_index = i - 1;
                add_type = 1;
            },
            focusChapter: function (i) {
                if (i < this.article.chapters.length && i >= 0) {
                    document.getElementById("c-" + i).focus();
                }
            },
            upChapter: function (i) {
                if (i >= 1) {
                    this.focusChapter(i - 1);
                }

                if (i == 0) {
                    this.focusTitle();
                }
            },
            downChapter: function (i) {
                if (i <= this.article.chapters.length - 2) {
                    this.focusChapter(i + 1);
                }
            },
            rightChapter: function (i) {
                // console.log("right", i);
                this.focusContent(i, 0);
            },
            addContent: function (i, j) {
                j++;
                console.log("add", i, j);
                this.article.chapters[i].lines.splice(j, 0, {
                    content: "",
                    translation: "",
                    reference: this.article.chapters[i].lines[j - 1].reference
                })
                current_chapter_index = i;
                current_chapter_line_index = j;
                add_type = 2;
            },
            delContent: function (i, j) {
                // if (confirm("sure to delete:"+this.article.chapters[i].lines[i].content+"?")==false){ 
                //     return
                // }
                console.log("del", i, j);
                if (this.article.chapters[i].lines.length == 1) {
                    return;
                }
                this.article.chapters[i].lines.splice(j, 1);
                //foucs up item
                current_chapter_index = i;
                current_chapter_line_index = j - 1;
                add_type = 2;
            },
            upContent: function (i, j) {
                // console.log("up", i, j);
                if (j >= 1) {
                    this.focusContent(i, j - 1);
                }
                if (j == 0 && i - 1 >= 0) {
                    this.focusContent(i - 1, this.article.chapters[i - 1].lines.length - 1)
                }

            },
            downContent: function (i, j) {
                // console.log("down", i, j);
                if (j <= this.article.chapters[i].lines.length - 2) {
                    this.focusContent(i, j + 1);
                }
                if (j == this.article.chapters[i].lines.length - 1 && i + 1 <= this.article.chapters.length - 1) {
                    this.focusContent(i + 1, 0);
                }

            },
            leftContent: function (i, j) {
                // console.log("left", i, j);
                this.focusChapter(i);
            },
            focusContent: function (i, j) {
                if (i >= 0 && j >= 0 && j < this.article.chapters[i].lines.length) {
                    document.getElementById("c-" + i + "-c-" + j).focus();

                    current_chapter_index = i;
                    current_chapter_line_index = j;
                    this.content = this.article.chapters[i].lines[j].content;

                }
            },
            onfocusContent: function (i, j) {
                console.log("onfocusContent", i, j)
            },
            addReference: function (i) {
                i++;
                console.log("add reference", i);
                this.article.references.splice(i, 0, {id: (new Date()).valueOf(), text: ""})
                //focus
                current_reference_index = i;
                add_type = 3;
            },
            delReference: function (i) {
                if (this.article.references.length == 1) {
                    return
                }
                console.log("del reference", i);
                this.article.references.splice(i, 1)
            },
            focusReference: function (i) {
                if (i < this.article.references.length && i >= 0) {
                    document.getElementById("r-" + i).focus();
                }
            },
            setFooter: function () {
                if (this.article == null || this.article.chapters == null) {
                    return
                }
                var words = 0;
                var lines = 0;
                for (i = 0; i < this.article.chapters.length; i++) {
                    words += this.article.chapters[i].title.length;
                    for (j = 0; j < this.article.chapters[i].lines.length; j++) {
                        words += this.article.chapters[i].lines[j].content.length;
                        if (this.article.chapters[i].lines[j].content != "") {
                            lines++;
                        }
                    }
                }
                // console.log("words", total);
                if (this.article.words != words) {
                    this.article.words = words;
                }
                if (this.article.lines != lines) {
                    this.article.lines = lines;
                }
            },
            postArticle: function () {
                console.log("save", this.article.file);
                // return
                axios.post('/article', this.article, {
                    headers:
                        {
                            'Content-Type': 'application/json'
                        }
                })
                    .then(function (response) {
                        console.log(response);
                        alert("保存成功！");
                    })
                    .catch(function (error) {
                        console.log(error);
                        alert("保存失败,文件已经存在！");
                    });
            },
            getArticle: function (name) {
                axios.get('/article/' + name)
                    .then(function (response) {
                        // console.log(response.data.title);
                        console.log(response.status);
                        // console.log(response.statusText);
                        // console.log(response.headers);
                        // console.log(response.config);
                        vm.article = response.data; // 这里不能用this，否则无法跟新
                    })
                    .catch(function (error) {
                        console.log(error);
                        alert("打开文件错误");
                        window.location.href="/";
                    });
            },
            showArticles: function () {
                axios.get('/folder')
                    .then(function (response) {
                        // console.log(response.data.title);
                        // console.log(response.status);
                        // console.log(response.statusText);
                        // console.log(response.headers);
                        // console.log(response.config);
                        vm.folder = response.data; // 这里不能用this，否则无法跟新
                    });
                $('#folderModal').modal('show');
            },
            confirmArticle: function () {
                $('#confirmModal').modal('show');
            },
            openArticles: function (name) {
                window.open("/edit/" + name);
            }

        },
        updated: function () {
            // console.log("updated", add_type, current_chapter_index);
            if (add_type == 1) {
                this.focusChapter(current_chapter_index);
            } else if (add_type == 2) {
                this.focusContent(current_chapter_index, current_chapter_line_index);
            } else if (add_type == 3) {
                this.focusReference(current_reference_index);
            }
            add_type = -1;

            this.setFooter();

            // newContent = this.article.chapters[current_chapter_index].lines[current_chapter_line_index].content;
            // if (this.content != newContent) {
            //     this.content = newContent;
            // }
        }
    })
    var create = {{.create}};
    var filename = {{.filename}};
    if (create == 1) {
        vm.newArticle(filename)
    } else {
        vm.getArticle(filename);
    }

    vm.focusTitle();
</script>

</html>